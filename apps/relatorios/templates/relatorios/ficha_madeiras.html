{% extends 'base.html' %}
{% block title %}Ficha de Madeiras{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <div class="card shadow-sm">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="fw-bold">
        <i class="fas fa-tree"></i> Ficha de Madeiras
      </div>

      <!-- Export do período (preserva filtros) -->
      <div class="d-flex gap-2 flex-wrap">
        {% with mes_q=request.GET.mes|default:mes ano_q=request.GET.ano|default:ano cliente_q=request.GET.cliente|default:cliente_id sort_q=request.GET.sort dir_q=request.GET.dir numero_q=request.GET.numero_romaneio tipo_q=request.GET.tipo_romaneio madeira_id_q=request.GET.tipo_madeira_id %}
          <a class="btn btn-outline-success btn-sm"
             href="{% url 'relatorios:ficha_madeiras_export_excel' %}?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}{% if sort_q %}&sort={{ sort_q }}{% endif %}{% if dir_q %}&dir={{ dir_q }}{% endif %}"
             title="Exportar a ficha em Excel (.xlsx)">
            <i class="fas fa-file-excel"></i> Excel
          </a>

          <a class="btn btn-outline-danger btn-sm"
             href="{% url 'relatorios:ficha_madeiras_export_pdf' %}?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}{% if sort_q %}&sort={{ sort_q }}{% endif %}{% if dir_q %}&dir={{ dir_q }}{% endif %}"
             title="Exportar a ficha em PDF">
            <i class="fas fa-file-pdf"></i> PDF
          </a>
        {% endwith %}
      </div>
    </div>

    <div class="card-body">
      <!-- ===== Filtros ===== -->
      <form method="get" class="row g-2 align-items-end mb-3">
        <div class="col-6 col-md-2 col-lg-2">
          <label class="form-label">Mês</label>
          <select name="mes" class="form-select">
            {% for m in meses %}
              <option value="{{ m }}"
                      {% if m|stringformat:"s" == request.GET.mes|default:mes|stringformat:"s" %}selected{% endif %}>
                {{ m|stringformat:"02d" }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-6 col-md-2 col-lg-2">
          <label class="form-label">Ano</label>
          <select name="ano" class="form-select">
            {% for a in anos %}
              <option value="{{ a }}"
                      {% if a|stringformat:"s" == request.GET.ano|default:ano|stringformat:"s" %}selected{% endif %}>
                {{ a }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4 col-lg-3">
          <label class="form-label">Cliente</label>
          <select name="cliente" class="form-select">
            <option value="">Todos</option>
            {% for c in clientes %}
              <option value="{{ c.id }}"
                      {% if c.id|stringformat:"s" == request.GET.cliente|default:cliente_id|stringformat:"s" %}selected{% endif %}>
                {{ c.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label">Nº Romaneio</label>
          <input type="text"
                 name="numero_romaneio"
                 class="form-control"
                 value="{{ request.GET.numero_romaneio|default:'' }}"
                 placeholder="Ex: 11669">
        </div>

        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label">Tipo</label>
          <select name="tipo_romaneio" class="form-select">
            <option value="">Todos</option>
            <option value="NORMAL" {% if request.GET.tipo_romaneio == "NORMAL" %}selected{% endif %}>Normal</option>
            <option value="COM_FRETE" {% if request.GET.tipo_romaneio == "COM_FRETE" %}selected{% endif %}>Com frete</option>
          </select>
        </div>

        <div class="col-12 col-md-6 col-lg-3">
          <label class="form-label">Tipo de madeira</label>
          <select name="tipo_madeira_id" class="form-select">
            <option value="">Todas</option>
            {% for tm in tipos_madeira %}
              <option value="{{ tm.id }}"
                      {% if tm.id|stringformat:"s" == request.GET.tipo_madeira_id %}selected{% endif %}>
                {{ tm.nome }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- preserva ordenação quando filtra -->
        <input type="hidden" name="sort" value="{{ request.GET.sort|default:'' }}">
        <input type="hidden" name="dir" value="{{ request.GET.dir|default:'' }}">

        <div class="col-12 col-md-3 col-lg-2 d-grid">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter"></i> Filtrar
          </button>
        </div>

        <div class="col-12 col-md-3 col-lg-2 d-grid">
          <a class="btn btn-outline-secondary"
             href="{% url 'relatorios:ficha_madeiras' %}"
             title="Limpar filtros">
            <i class="fas fa-eraser"></i> Limpar
          </a>
        </div>
      </form>

      <!-- ===== Totais do período ===== -->
      <div class="row g-2 mb-3">
        <div class="col-md-4">
          <div class="p-3 border rounded bg-light h-100">
            <div class="text-muted small">Total m³ (itens)</div>
            <div class="fw-bold fs-5">{{ total_m3|floatformat:3 }}</div>
          </div>
        </div>

        {% if total_bruto is not None %}
        <div class="col-md-4">
          <div class="p-3 border rounded bg-light h-100">
            <div class="text-muted small">Total bruto (romaneios)</div>
            <div class="fw-bold fs-5">R$ {{ total_bruto|floatformat:2 }}</div>
          </div>
        </div>
        {% endif %}

        <div class="col-md-4">
          <div class="p-3 border rounded bg-light h-100">
            <div class="text-muted small">Total (R$)</div>
            <div class="fw-bold fs-5">R$ {{ total_itens|floatformat:2 }}</div>
          </div>
        </div>
      </div>

      {% with mes_q=request.GET.mes|default:mes ano_q=request.GET.ano|default:ano cliente_q=request.GET.cliente|default:cliente_id numero_q=request.GET.numero_romaneio tipo_q=request.GET.tipo_romaneio madeira_id_q=request.GET.tipo_madeira_id sort=request.GET.sort|default:"data" dir=request.GET.dir|default:"asc" %}
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 120px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=data&dir={% if sort == 'data' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Data
                    {% if sort == "data" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th style="width: 130px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=numero&dir={% if sort == 'numero' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Nº Romaneio
                    {% if sort == "numero" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th>
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=madeira&dir={% if sort == 'madeira' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Tipo Madeira
                    {% if sort == "madeira" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th style="width: 120px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=tipo&dir={% if sort == 'tipo' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Tipo
                    {% if sort == "tipo" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th class="text-end" style="width: 150px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=valor_unit&dir={% if sort == 'valor_unit' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Valor Unit.
                    {% if sort == "valor_unit" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th class="text-end" style="width: 110px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=m3&dir={% if sort == 'm3' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    M³
                    {% if sort == "m3" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>

                <th class="text-end" style="width: 140px;">
                  <a class="text-decoration-none"
                     href="?mes={{ mes_q }}&ano={{ ano_q }}{% if cliente_q %}&cliente={{ cliente_q }}{% endif %}{% if numero_q %}&numero_romaneio={{ numero_q }}{% endif %}{% if tipo_q %}&tipo_romaneio={{ tipo_q }}{% endif %}{% if madeira_id_q %}&tipo_madeira_id={{ madeira_id_q }}{% endif %}&sort=total&dir={% if sort == 'total' and dir == 'asc' %}desc{% else %}asc{% endif %}">
                    Total
                    {% if sort == "total" %}{% if dir == "asc" %}▲{% else %}▼{% endif %}{% endif %}
                  </a>
                </th>
              </tr>
            </thead>

            <tbody>
              {% for row in rows %}
                <tr>
                  <td>{{ row.romaneio.data_romaneio|date:"d/m/Y" }}</td>
                  <td class="fw-semibold">#{{ row.romaneio.numero_romaneio }}</td>
                  <td>{{ row.tipo_madeira.nome }}</td>

                  <td>
                    {% if row.romaneio.tipo_romaneio == "COM_FRETE" %}
                      <span class="badge text-bg-warning">Com frete</span>
                    {% else %}
                      <span class="badge text-bg-success">Normal</span>
                    {% endif %}
                  </td>

                  <td class="text-end">R$ {{ row.valor_unitario|default_if_none:0|floatformat:2 }}</td>
                  <td class="text-end">{{ row.quantidade_m3_total|default_if_none:0|floatformat:3 }}</td>
                  <td class="text-end fw-bold">R$ {{ row.valor_total|default_if_none:0|floatformat:2 }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    Nenhum dado encontrado para o período selecionado.
                  </td>
                </tr>
              {% endfor %}
            </tbody>

            {% if rows %}
              <tfoot>
                <tr class="table-active fw-bold">
                  <td colspan="5" class="text-end">TOTAL</td>
                  <td class="text-end">{{ total_m3|floatformat:3 }}</td>
                  <td class="text-end">R$ {{ total_itens|floatformat:2 }}</td>
                </tr>
              </tfoot>
            {% endif %}
          </table>
        </div>
      {% endwith %}

      <div class="text-muted small mt-2">
        Dica: clique nos títulos das colunas para ordenar. Cada linha corresponde a um <b>item do romaneio</b>.
      </div>
    </div>
  </div>
</div>
{% endblock %}