{% extends 'base.html' %}
{% block title %}Ficha de Romaneios{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>
            <i class="fas fa-file-invoice"></i> Ficha de Romaneios
        </span>
        <!-- Botão exportar relatório -->
        <form method="get" action="{% url 'relatorios:ficha_romaneios_export' %}" class="mb-0" target="_blank">
            <input type="hidden" name="mes" value="{{ request.GET.mes|default:mes }}">
            <input type="hidden" name="ano" value="{{ request.GET.ano|default:ano }}">
            <input type="hidden" name="cliente" value="{{ request.GET.cliente }}">
            <button class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-file-export"></i> Exportar relatório (.CSV)
            </button>
        </form>
    </div>

    <div class="card-body">
        <!-- Filtros por período e cliente -->
        <form method="get" class="row gx-2 gy-2 mb-4">
            <div class="col-md-2">
                <label class="form-label">Mês</label>
                <select name="mes" class="form-select">
                    {% for m in meses %}
                        <option value="{{ m }}"
                            {% if m|stringformat:"s" == request.GET.mes|default:mes|stringformat:"s" %}selected{% endif %}>
                            {{ m }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Ano</label>
                <select name="ano" class="form-select">
                    {% for a in anos %}
                        <option value="{{ a }}"
                            {% if a|stringformat:"s" == request.GET.ano|default:ano|stringformat:"s" %}selected{% endif %}>
                            {{ a }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Cliente</label>
                <select name="cliente" class="form-select">
                    <option value="">Todos</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}"
                            {% if cliente.id|stringformat:"s" == request.GET.cliente %}
                                selected
                            {% endif %}
                        >{{ cliente.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter"></i> Filtrar
                </button>
            </div>
        </form>

        <!-- Totais do período -->
        <div class="mb-3">
            <span class="badge bg-primary me-2">
                <i class="fas fa-cube"></i> Total m³: {{ total_m3_periodo|floatformat:3 }}
            </span>
            <span class="badge bg-success me-2">
                <i class="fas fa-dollar-sign"></i> Total Valor: R$ {{ total_valor_periodo|floatformat:2 }}
            </span>
            <span class="text-muted ms-2">({{ romaneios|length }} romaneios)</span>
        </div>

        <!-- Tabela de romaneios do período -->
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Cliente</th>
                        <th>Nº de Romaneio</th>
                        <th>Data Romaneio</th>
                        <th>Tipo</th>
                        <th class="text-end">M³</th>
                        <th class="text-end">Total R$</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for romaneio in romaneios %}
                    <tr>
                        <td>{{ romaneio.cliente.nome }}</td>
                        <td>{{ romaneio.numero_romaneio }}</td>
                        <td>{{ romaneio.data_romaneio|date:"d/m/Y" }}</td>
                        <td>
                            {% if romaneio.tipo_romaneio == "NORMAL" %}
                                <span class="badge bg-primary">Normal</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Com Frete</span>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ romaneio.m3_total|floatformat:3 }}</td>
                        <td class="text-end">R$ {{ romaneio.valor_total|floatformat:2 }}</td>

                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Ações exportação">
                                <a class="btn btn-outline-dark"
                                   href="{% url 'relatorios:romaneio_export_pdf' romaneio.id %}"
                                   target="_blank"
                                   title="Exportar PDF (impressão)">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </a>
                                <a class="btn btn-outline-success"
                                   href="{% url 'relatorios:romaneio_export_excel' romaneio.id %}"
                                   target="_blank"
                                   title="Exportar Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            Nenhum romaneio encontrado neste período/filtros.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}