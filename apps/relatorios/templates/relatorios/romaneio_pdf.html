<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Romaneio Nº {{ romaneio.numero_romaneio }}</title>

  <style>
    /* ===== Página / impressão ===== */
    @page {
      size: A4;
      margin: 18mm 16mm 18mm 16mm;

      @bottom-right {
        content: "Página " counter(page) " de " counter(pages);
        font-size: 10px;
        color: #666;
      }
    }

    :root {
      --brand: #246b29;
      --brand-2: #3b4671;
      --warning: #D8850D;

      --text: #222;
      --muted: #666;
      --line: #cfd4dc;

      --bg-soft: #f6f7f8;
      --bg-head: #eef3ef;
      --bg-head-2: #f0f0fa;
    }

    html, body { padding: 0; margin: 0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 12px;
      color: var(--text);
    }

    /* Evita orfãs/viúvas feias em PDF */
    p, h1, h2, h3 { orphans: 3; widows: 3; }

    /* ===== Cabeçalho ===== */
    .doc-header {
      border-bottom: 2px solid var(--brand);
      padding-bottom: 10px;
      margin-bottom: 14px;
    }

    .doc-header table { width: 100%; border-collapse: collapse; }
    .doc-header td { vertical-align: bottom; }

    .title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      line-height: 1.1;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .badges { margin-top: 6px; }
    .badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      padding: 3px 10px;
      border-radius: 999px;
      margin-right: 6px;
      letter-spacing: .2px;
    }
    .badge-normal { background: var(--brand); }
    .badge-com_frete { background: var(--warning); }
    .badge-simples { background: #999; }
    .badge-detalhado { background: var(--brand-2); }

    .right { text-align: right; }

    /* ===== Bloco de informações ===== */
    .box {
      background: var(--bg-soft);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
    }

    .info-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .info-grid td { padding: 4px 6px; }
    .label { color: var(--muted); font-weight: 700; text-transform: uppercase; font-size: 10px; }
    .value { font-size: 12px; font-weight: 700; }

    /* ===== Totais ===== */
    .totais {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    .totais td {
      width: 33.33%;
      padding: 0 6px;
    }
    .total-card {
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    .total-card .k { color: var(--muted); font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .total-card .v { font-size: 16px; font-weight: 800; margin-top: 4px; }

    /* ===== Seções ===== */
    h2 {
      font-size: 14px;
      margin: 16px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--line);
    }

    /* ===== Tabelas ===== */
    table.tbl {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
    }

    table.tbl thead th {
      background: var(--bg-head);
      border: 1px solid var(--line);
      padding: 6px;
      font-size: 11px;
      text-align: left;
      font-weight: 800;
    }

    table.tbl tbody td {
      border: 1px solid var(--line);
      padding: 6px;
      font-size: 11px;
      vertical-align: top;
    }

    .num { text-align: right; white-space: nowrap; }
    .center { text-align: center; white-space: nowrap; }

    /* Evitar quebra feia dentro do item/unidades */
    tr.item-row { page-break-inside: avoid; }
    tr.unidades-wrap { page-break-inside: avoid; }
    .unidades-box { page-break-inside: avoid; }

    /* Zebra nas unidades para leitura */
    table.unidades thead th { background: var(--bg-head-2); }
    table.unidades tbody tr:nth-child(even) td { background: #fafafa; }

    /* Quando o PDF quebra página, repetir cabeçalho ajuda muito */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    .muted { color: var(--muted); }

    .footer-note {
      margin-top: 10px;
      font-size: 10px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <div class="doc-header">
    <table>
      <tr>
        <td>
          <p class="title">Romaneio Nº {{ romaneio.numero_romaneio }}</p>
          <div class="subtitle">
            Emitido em {{ romaneio.data_romaneio|date:"d/m/Y" }} &nbsp;|&nbsp; Impresso em {{ now|date:"d/m/Y H:i" }}
          </div>

          <div class="badges">
            <span class="badge badge-{{ romaneio.tipo_romaneio|lower }}">
              {{ romaneio.get_tipo_romaneio_display }}
            </span>
            <span class="badge badge-{{ romaneio.modalidade|lower }}">
              {{ romaneio.get_modalidade_display }}
            </span>
            {% if romaneio.motorista %}
              <span class="badge" style="background:#666">Motorista: {{ romaneio.motorista.nome }}</span>
            {% endif %}
          </div>
        </td>

        <td class="right">
          <div class="subtitle"><b>Cliente</b></div>
          <div style="font-weight:800; font-size:13px">{{ romaneio.cliente.nome }}</div>
        </td>
      </tr>
    </table>
  </div>

  <div class="box">
    <table class="info-grid">
      <tr>
        <td>
          <div class="label">Cliente</div>
          <div class="value">{{ romaneio.cliente.nome }}</div>
        </td>
        <td>
          <div class="label">Data do Romaneio</div>
          <div class="value">{{ romaneio.data_romaneio|date:"d/m/Y" }}</div>
        </td>
        <td>
          <div class="label">Itens</div>
          <div class="value">{{ itens|length }}</div>
        </td>
      </tr>
      <tr>
        <td>
          <div class="label">Cadastrado por</div>
          <div class="value">
            {% if romaneio.usuario_cadastro %}
              {{ romaneio.usuario_cadastro.get_full_name|default:romaneio.usuario_cadastro.username }}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          </div>
        </td>
        <td>
          <div class="label">Cadastro em</div>
          <div class="value">{{ romaneio.data_cadastro|date:"d/m/Y H:i" }}</div>
        </td>
        <td>
          <div class="label">Atualização</div>
          <div class="value">{{ romaneio.data_atualizacao|date:"d/m/Y H:i" }}</div>
        </td>
      </tr>
    </table>

    <table class="totais">
      <tr>
        <td>
          <div class="total-card">
            <div class="k">Total m³</div>
            <div class="v">{{ romaneio.m3_total|floatformat:3 }}</div>
          </div>
        </td>
        <td>
          <div class="total-card">
            <div class="k">Valor bruto</div>
            <div class="v">R$ {{ romaneio.valor_bruto|floatformat:2 }}</div>
          </div>
        </td>
        <td>
          <div class="total-card">
            <div class="k">Valor líquido</div>
            <div class="v">R$ {{ romaneio.valor_total|floatformat:2 }}</div>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <h2>Itens do Romaneio</h2>

  <table class="tbl">
    <thead>
      <tr>
        <th>Espécie</th>
        <th class="num">Qtd (m³)</th>
        <th class="num">Valor Unit. (R$/m³)</th>
        <th class="num">Total (R$)</th>
        {% if romaneio.modalidade == "DETALHADO" %}
          <th class="center">Unidades</th>
        {% endif %}
      </tr>
    </thead>

    <tbody>
      {% for item in itens %}
        <tr class="item-row">
          <td><b>{{ item.tipo_madeira.nome }}</b></td>
          <td class="num">{{ item.quantidade_m3_total|floatformat:3 }}</td>
          <td class="num">R$ {{ item.valor_unitario|floatformat:2 }}</td>
          <td class="num"><b>R$ {{ item.valor_total|floatformat:2 }}</b></td>
          {% if romaneio.modalidade == "DETALHADO" %}
            <td class="center">{{ item.unidades.count }}</td>
          {% endif %}
        </tr>

        {% if romaneio.modalidade == "DETALHADO" and item.unidades.exists %}
          <tr class="unidades-wrap">
            <td colspan="5" style="padding:8px">
              <div class="label" style="margin-bottom:6px">
                Unidades (Toras) — {{ item.tipo_madeira.nome }}
              </div>

              <div class="unidades-box">
                <table class="tbl unidades">
                  <thead>
                    <tr>
                      <th style="width:38px" class="center">#</th>
                      <th class="num">Comprimento (m)</th>
                      <th class="num">Rôdo (cm)</th>
                      <th class="num">Desc. 1 (cm)</th>
                      <th class="num">Desc. 2 (cm)</th>
                      <th class="num">Qtd (m³)</th>
                    </tr>
                  </thead>

                  <tbody>
                    {% for unidade in item.unidades.all %}
                      <tr>
                        <td class="center">{{ forloop.counter }}</td>

                        <td class="num">
                          {% if unidade.comprimento is not None %}
                            {{ unidade.comprimento|floatformat:2 }}
                          {% else %}
                            —
                          {% endif %}
                        </td>

                        <td class="num">
                          {% if unidade.rodo is not None %}
                            {{ unidade.rodo|floatformat:2 }}
                          {% else %}
                            —
                          {% endif %}
                        </td>

                        <td class="num">
                          {% if unidade.desconto_1 and unidade.desconto_1 > 0 %}
                            {{ unidade.desconto_1|floatformat:2 }}
                          {% else %}
                            —
                          {% endif %}
                        </td>

                        <td class="num">
                          {% if unidade.desconto_2 and unidade.desconto_2 > 0 %}
                            {{ unidade.desconto_2|floatformat:2 }}
                          {% else %}
                            —
                          {% endif %}
                        </td>

                        <td class="num"><b>{{ unidade.quantidade_m3|floatformat:3 }}</b></td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="6" class="center muted">Sem toras registradas para este item.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        {% endif %}

      {% empty %}
        <tr>
          <td colspan="{% if romaneio.modalidade == "DETALHADO" %}5{% else %}4{% endif %}" class="center muted">
            Nenhum item registrado.
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  

  <div class="footer-note">
    Documento gerado automaticamente pelo sistema MadereiraJD.
  </div>
</body>
</html>