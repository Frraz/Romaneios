{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}{% if object %}Editar Cliente{% else %}Novo Cliente{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .input-cpf-cnpj {
        letter-spacing: 0.06em;
        font-family: monospace;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mx-auto mt-4 shadow-sm" style="max-width: 600px;">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-user"></i>
        {% if object %}Editar{% else %}Novo{% endif %} Cliente
    </div>
    <div class="card-body">

        <form method="post" novalidate autocomplete="off">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="alert alert-danger mb-3">
                    {% for error in form.non_field_errors %}
                        <div>{{ error }}</div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="mb-3">
                {{ form.nome.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                    {{ form.nome|add_class:"form-control" }}
                </div>
                {% if form.nome.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.nome.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <!-- Tipo de pessoa: Física / Jurídica -->
            <div class="mb-3">
                <label class="form-label">{{ form.tipo_pessoa.label }}</label>
                <div>
                    {% for radio in form.tipo_pessoa %}
                        <div class="form-check form-check-inline">
                            {{ radio.tag }}
                            <label class="form-check-label" for="{{ radio.id_for_label }}">
                                {{ radio.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                </div>
                {% if form.tipo_pessoa.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.tipo_pessoa.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.cpf_cnpj.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                    {{ form.cpf_cnpj|add_class:"form-control input-cpf-cnpj" }}
                </div>
                {% if form.cpf_cnpj.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.cpf_cnpj.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
                <small class="form-text text-muted">
                    <strong>Opcional:</strong> preencha apenas se quiser informar e selecione o tipo.<br>
                    <span class="d-block">
                        <b>Pessoa Física:</b> CPF (<code>000.000.000-00</code>)<br>
                        <b>Pessoa Jurídica:</b> CNPJ (<code>00.000.000/0000-00</code>)
                    </span>
                </small>
            </div>

            <div class="mb-3">
                {{ form.telefone.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                    {{ form.telefone|add_class:"form-control" }}
                </div>
                {% if form.telefone.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.telefone.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="mb-3">
                {{ form.endereco.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                    {{ form.endereco|add_class:"form-control" }}
                </div>
                {% if form.endereco.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.endereco.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="form-check mb-4">
                {{ form.ativo|add_class:"form-check-input" }}
                {{ form.ativo.label_tag }}
                {% if form.ativo.errors %}
                    <div class="text-danger small mt-1">
                        {% for error in form.ativo.errors %}<div>{{ error }}</div>{% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <a href="{% url 'cadastros:cliente_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </form>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script>
$(document).ready(function () {
    var $campo = $(".input-cpf-cnpj");
    var $radios = $("input[name='tipo_pessoa']");

    function aplicarMascaraPorTipo() {
        var tipo = $radios.filter(":checked").val(); // "F" ou "J"
        $campo.unmask();
        if (tipo === "J") {
            $campo.mask("00.000.000/0000-00");
        } else {
            $campo.mask("000.000.000-00");
        }
    }

    aplicarMascaraPorTipo();

    $radios.on("change", function () {
        var digitos = $campo.val().replace(/\D/g, "");
        aplicarMascaraPorTipo();
        $campo.val(digitos);
        $campo.trigger("input");
    });
});
</script>
{% endblock %}